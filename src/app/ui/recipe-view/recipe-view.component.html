@if (data && meta) {
  <div class="max-w-4xl mx-auto bg-white p-8 md:p-16 shadow-2xl my-12 relative animate-fade-in text-stone-800 select-none">
  
    <!-- Paper Texture Overlay -->
    <div class="absolute inset-0 pointer-events-none opacity-[0.03]" style="background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png')"></div>

    <!-- Header -->
    <div class="text-center mb-16 select-text cursor-text">
      <p class="font-sans text-[10px] uppercase tracking-[0.3em] text-stone-400 mb-4">{{ meta.preparation_time_minutes }} {{ lang.t().meta_execution }} &mdash; {{ meta.difficulty_level }}</p>
      <h1 class="font-serif italic text-3xl md:text-4xl mb-6">{{ meta.dish_name }}</h1>
      <div class="w-16 h-px bg-stone-300 mx-auto mb-6"></div>
      
      <!-- INSERTED IMAGE DISPLAY -->
      @if (insertedImage()) {
         <div class="mb-8 animate-[fadeIn_0.5s_ease-out]">
            <img [src]="insertedImage()" class="w-full max-h-[500px] object-contain shadow-2xl rounded-sm mx-auto" alt="Dish Visualization">
         </div>
      }

      <p class="font-serif text-xl italic text-stone-600 max-w-2xl mx-auto leading-relaxed">
        {{ meta.concept_summary }}
      </p>
    </div>

    <!-- Rationale -->
    <div class="mb-16 text-center select-text cursor-text">
      <p class="font-serif text-lg leading-loose text-stone-800 px-8 border-l-2 border-stone-200 inline-block text-left">
        {{ data.rationale }}
      </p>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-12 border-t border-b border-stone-100 py-12">
      
      <!-- Ingredients -->
      <div class="md:col-span-1 text-center md:text-right border-b md:border-b-0 md:border-r border-stone-100 pb-8 md:pb-0 md:pr-8 select-text cursor-text">
        <h3 class="font-sans text-xs uppercase tracking-[0.2em] text-stone-400 mb-6 select-none cursor-default">{{ lang.t().section_mise_en_place }}</h3>
        <ul class="space-y-4 font-serif text-lg">
          @for (item of data.ingredients; track item.name) {
            <li>
              <span class="font-bold block text-stone-900">{{ item.name }}</span>
              <span class="italic text-stone-500 text-base">{{ item.quantity }}</span>
            </li>
          }
        </ul>
      </div>

      <!-- Execution -->
      <div class="md:col-span-2 md:pl-4 select-text cursor-text">
        <h3 class="font-sans text-xs uppercase tracking-[0.2em] text-stone-400 mb-6 select-none cursor-default">{{ lang.t().section_preparation }}</h3>
        <div class="space-y-8">
          @for (step of data.steps; track step.step_number) {
            <div class="relative pl-12">
              <span class="absolute left-0 top-0 font-script text-4xl text-stone-200 select-none">{{ step.step_number }}</span>
              <p class="font-serif text-lg leading-relaxed text-stone-800">
                {{ step.instruction }}
              </p>
              @if (step.technical_note) {
                <p class="mt-2 text-sm font-sans text-stone-500 uppercase tracking-wider">
                  {{ lang.t().tip_label }}: {{ step.technical_note }}
                </p>
              }
            </div>
          }
        </div>
      </div>
    </div>
    
    <!-- HOMEMADE PREPS SECTION -->
    @if (data.homemade_preps && data.homemade_preps.length > 0) {
      <div class="py-12 border-b border-stone-100 bg-stone-50/50 -mx-8 md:-mx-16 px-8 md:px-16 select-text cursor-text">
         <h3 class="font-sans text-xs uppercase tracking-[0.2em] text-stone-400 mb-8 text-center">{{ lang.t().section_homemade }}</h3>
         
         <div class="grid grid-cols-1 gap-8">
            @for (prep of data.homemade_preps; track prep.name) {
               <div class="bg-white border border-stone-200 p-6 shadow-sm">
                  <div class="flex justify-between items-baseline border-b border-stone-100 pb-2 mb-4">
                     <h4 class="font-serif font-bold text-xl text-stone-900">{{ prep.name }}</h4>
                     <span class="font-sans text-[10px] uppercase tracking-widest text-stone-500">{{ prep.yield }}</span>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                     <div class="md:col-span-1">
                        <span class="font-sans text-[9px] uppercase tracking-widest text-stone-400 block mb-2">Ingredients</span>
                        <ul class="text-sm font-serif text-stone-600 space-y-1">
                           @for (ing of prep.ingredients; track ing) {
                              <li>â€¢ {{ ing }}</li>
                           }
                        </ul>
                     </div>
                     <div class="md:col-span-2">
                        <span class="font-sans text-[9px] uppercase tracking-widest text-stone-400 block mb-2">Method</span>
                        <p class="text-sm font-serif leading-relaxed text-stone-800">{{ prep.instructions }}</p>
                     </div>
                  </div>
               </div>
            }
         </div>
      </div>
    }

    <!-- NUTRITIONAL INFO SECTION (NEW) -->
    <div class="py-12 border-b border-stone-100 -mx-8 md:-mx-16 px-8 md:px-16">
       <h3 class="font-sans text-xs uppercase tracking-[0.2em] text-stone-400 mb-8 text-center">{{ lang.t().section_nutrition }}</h3>
       <div class="flex flex-wrap justify-center gap-12 text-center">
          
          <div class="flex flex-col items-center">
             <span class="font-serif text-3xl text-stone-800 font-bold mb-1">{{ meta.calories_estimate }} kcal</span>
             <span class="font-sans text-[9px] uppercase tracking-widest text-stone-400">{{ lang.t().nutr_calories }}</span>
          </div>

          <div class="w-px bg-stone-200 h-12"></div>

          <div class="flex flex-col items-center">
             <span class="font-serif text-3xl text-stone-800 font-bold mb-1">{{ meta.abv_estimate }}</span>
             <span class="font-sans text-[9px] uppercase tracking-widest text-stone-400">{{ lang.t().nutr_abv }}</span>
          </div>

       </div>
    </div>

    <!-- STRATEGIC TOOLKIT -->
    <div class="mt-12 pt-8 border-t border-stone-100 select-none">
       <div class="flex flex-col items-center gap-4">
          <h4 class="font-sans text-[10px] uppercase tracking-[0.3em] text-stone-400">{{ lang.t().section_toolkit }}</h4>
          
          <div class="flex flex-wrap gap-4 justify-center">
             <button (click)="triggerPhotoPromptGeneration()" class="bg-stone-900 text-white px-6 py-3 font-sans text-[10px] uppercase tracking-[0.2em] hover:bg-stone-700 transition-all shadow-lg flex items-center gap-2 cursor-pointer">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
               </svg>
               {{ lang.t().btn_gen_photo }}
             </button>

             <button (click)="exportChefCopy()" class="bg-white border border-stone-300 text-stone-800 px-6 py-3 font-sans text-[10px] uppercase tracking-[0.2em] hover:bg-stone-50 transition-all flex items-center gap-2 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                {{ lang.t().btn_download }}
             </button>

             <button (click)="exportRecipeCode()" class="bg-white border border-stone-300 text-stone-800 px-6 py-3 font-sans text-[10px] uppercase tracking-[0.2em] hover:bg-stone-50 transition-all flex items-center gap-2 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 18" />
                </svg>
                {{ lang.t().btn_export_code }}
             </button>
          </div>
       </div>
    </div>

    <!-- LOADING OVERLAY -->
    @if (isProcessing()) {
       <div class="absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center animate-fade-in">
          <div class="w-12 h-12 border-4 border-stone-200 border-t-stone-800 rounded-full animate-spin mb-4"></div>
          <p class="font-sans text-xs uppercase tracking-widest text-stone-500 animate-pulse">{{ processingMessage() }}</p>
       </div>
    }

  </div>
}

<!-- PHOTO PROMPT MODAL -->
@if (showPhotoPromptModal()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm animate-fade-in">
     <div class="w-full max-w-2xl relative">
        <button (click)="closeModal()" class="absolute -top-12 right-0 text-white hover:text-stone-300 transition-colors cursor-pointer">
           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
             <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
           </svg>
        </button>
        
        @if (promptState() === 'loading') {
          <div class="bg-white p-12 text-center rounded shadow-xl">
            <div class="animate-spin w-8 h-8 border-2 border-stone-300 border-t-stone-800 rounded-full mx-auto mb-4"></div>
            <p class="font-serif text-stone-600 italic">Crafting visual prompt...</p>
          </div>
        } @else if (promptState() === 'error') {
          <div class="bg-white p-12 text-center rounded shadow-xl">
            <p class="font-serif text-red-600 mb-4">Failed to generate prompt</p>
            <button (click)="triggerPhotoPromptGeneration()" class="bg-stone-800 text-white px-4 py-2 text-sm cursor-pointer">Retry</button>
          </div>
        } @else if (photoPrompt()) {
          <app-photo-prompt 
             [initialPrompt]="photoPrompt()!" 
             (imageSelected)="onImageInserted($event)"
             (closeRequested)="closeModal()">
          </app-photo-prompt>
        }
     </div>
  </div>
}